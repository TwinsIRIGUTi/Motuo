<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>モツオポーカー</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #hand {
      margin: 20px auto;
      display: grid;
      grid-template-columns: repeat(6, 60px);
      gap: 10px;
      justify-content: center;
    }
    .card {
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 20px;
      width: 60px;
      height: 60px;
      line-height: 60px;
      cursor: pointer;
      user-select: none;
      background-color: white;
      color: black;
      transition: 0.2s;
    }
    .card.selected { background-color: lightblue; }
    .card.hinted { color: red; }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
    }
    #word-list {
      font-size: 14px;
      margin-top: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }
    #word-list span {
      border: 1px solid #ccc;
      padding: 3px 6px;
      border-radius: 4px;
      background: #f9f9f9;
    }
    #final-score {
      margin-top: 30px;
      font-size: 24px;
      font-weight: bold;
      color: crimson;
    }
  </style>
</head>
<body>
  <h1>モツオポーカー</h1>
  <div id="score">スコア: 0</div>
  <div id="remaining">残りカード: 0</div>
  <div id="hint-count">ヒント残り: 5</div>
  <div id="hand"></div>
  <button id="confirm">決定</button>
  <button id="hint">ヒント</button>
  <div id="played"></div>
  <div id="status"></div>
  <div id="final-score"></div>
  <div id="restart-container"></div>
  <h3>成立する単語一覧</h3>
  <div id="word-list"></div>

  <script>
    const validWords = [
      "シロ", "シロシオ", "シロタレ", "シロミソ", "シロスヤキ", "シロナマ",
      "レバ", "レバシオ", "レバタレ", "レバミソ", "レバスヤキ", "レバボイル",
      "ガツ", "ガツシオ", "ガツタレ", "ガツミソ", "ガツスヤキ", "ガツナマ",
      "ナンコツ", "ナンコツシオ", "ナンコツタレ", "ナンコツミソ", "ナンコツスヤキ",
      "アブラ", "アブラシオ", "アブラタレ", "アブラミソ", "アブラナマ",
      "ハツ", "ハツシオ", "ハツタレ", "ハツミソ", "ハツスヤキ", "ハツナマ",
      "カシラ", "カシラシオ", "カシラタレ", "カシラミソ",
      "ビール", "ウメワリ", "ブドウワリ", "ウイスキー", "サイダー",
      "ツル", "ツルシオ", "ツルスヤキ", "ツルミソ", "ツルタレ",
      "シンキ", "タンナマ", "オシンコ", "ダイコン", "ニコミ", "ホネ", "ツインズ"
    ];

    const charDistribution = {
      "レ": 6, "バ": 6, "シ": 5, "ツ": 5, "カ": 5, "ラ": 5, "ガ": 5,
      "ミ": 3, "ソ": 3, "ロ": 2, "ハ": 2
    };
    const allKana = [...new Set(validWords.join("").split(""))];
    allKana.forEach(k => { if (!(k in charDistribution)) charDistribution[k] = 1; });

    let deck = [], hand = [], selected = [], score = 0, hintCount = 5, hintedIndexes = new Set();

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function createDeck() {
      deck = [];
      for (const [char, count] of Object.entries(charDistribution)) {
        for (let i = 0; i < count; i++) deck.push(char);
      }
      deck.push("Wild", "Wild", "Wild", "Wild");
      shuffle(deck);
      updateRemaining();
    }

    function deal(n) {
      return deck.splice(0, n);
    }

    function updateRemaining() {
      document.getElementById("remaining").innerText = `残りカード: ${deck.length}`;
    }

    function updateScore() {
      document.getElementById("score").innerText = `スコア: ${score}`;
    }

    function updateHintCount() {
      document.getElementById("hint-count").innerText = `ヒント残り: ${hintCount}`;
    }

    function drawHand() {
      const handDiv = document.getElementById("hand");
      handDiv.innerHTML = "";
      hand.forEach((card, i) => {
        const div = document.createElement("div");
        div.className = "card";
        if (selected.includes(i)) div.classList.add("selected");
        if (hintedIndexes.has(i)) div.classList.add("hinted");
        div.innerText = card;
        div.onclick = () => {
          if (selected.includes(i)) {
            selected = selected.filter(idx => idx !== i);
          } else {
            selected.push(i);
          }
          drawHand();
        };
        handDiv.appendChild(div);
      });
    }

    function permuteWithWildcards(arr) {
      const results = [];
      const used = Array(arr.length).fill(false);
      function backtrack(path) {
        if (path.length === arr.length) {
          results.push([...path]);
          return;
        }
        for (let i = 0; i < arr.length; i++) {
          if (used[i]) continue;
          used[i] = true;
          if (arr[i] === "Wild") {
            for (const kana of Object.keys(charDistribution)) {
              path.push(kana);
              backtrack(path);
              path.pop();
            }
          } else {
            path.push(arr[i]);
            backtrack(path);
            path.pop();
          }
          used[i] = false;
        }
      }
      backtrack([]);
      return results;
    }

    function isWordFormable(word, cards) {
      const cardCount = {};
      let wildCount = 0;
      cards.forEach(c => {
        if (c === "Wild") wildCount++;
        else cardCount[c] = (cardCount[c] || 0) + 1;
      });
      for (const ch of word) {
        if ((cardCount[ch] || 0) > 0) cardCount[ch]--;
        else if (wildCount > 0) wildCount--;
        else return false;
      }
      return true;
    }

    function findValidWordFromHand() {
      const cards = hand.slice();
      const sortedWords = [...validWords].sort((a, b) => b.length - a.length);
      for (const word of sortedWords) {
        if (isWordFormable(word, cards)) return word;
      }
      return null;
    }

    function hint() {
      if (hintCount <= 0) return alert("ヒントはもう使えません！");
      hintedIndexes.clear();
      const foundWord = findValidWordFromHand();
      if (!foundWord) return alert("成立する単語がありません。");
      const tempHand = hand.slice();
      const usedIndexes = [];
      for (const ch of foundWord) {
        let idx = tempHand.findIndex(c => c === ch);
        if (idx === -1) idx = tempHand.findIndex(c => c === "Wild");
        if (idx !== -1) {
          usedIndexes.push(idx);
          tempHand[idx] = null;
        }
      }
      usedIndexes.forEach(i => hintedIndexes.add(i));
      hintCount--;
      updateHintCount();
      drawHand();
    }

    function play() {
      const chosen = selected.map(i => hand[i]);
      if (chosen.length === 0) return;
      const perms = permuteWithWildcards(chosen);
      const results = perms.map(p => p.join("")).filter(w => validWords.includes(w));
      const playedDiv = document.getElementById("played");
      if (results.length > 0) {
        const word = results[0];
        const total = word.length;
        score += total;
        playedDiv.innerText = `成立: ${word} +${total}点`;
        selected.forEach(i => {
          hand[i] = deck.length > 0 ? deal(1)[0] : null;
        });
        hand = hand.filter(c => c !== null);
      } else {
        playedDiv.innerText = "不成立。カードを引き直します。";
        selected.forEach(i => {
          hand[i] = deck.length > 0 ? deal(1)[0] : null;
        });
        hand = hand.filter(c => c !== null);
      }
      selected = [];
      hintedIndexes.clear();
      drawHand();
      updateScore();
      updateRemaining();
      updateHintCount();
      if (deck.length === 0 || hand.length === 0) {
        document.getElementById("final-score").innerText = `ゲーム終了！スコア: ${score}点`;
      }
    }

    function showWordList() {
      const div = document.getElementById("word-list");
      validWords.forEach(w => {
        const span = document.createElement("span");
        span.innerText = w;
        div.appendChild(span);
      });
    }

    document.getElementById("confirm").onclick = play;
    document.getElementById("hint").onclick = hint;

    createDeck();
    hand = deal(12);
    drawHand();
    updateScore();
    updateHintCount();
    showWordList();
  </script>
</body>
</html>
